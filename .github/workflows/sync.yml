name: Auto Sync 天神接口（ff.zip）& Build Merged Interface

permissions:
  contents: write

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      # 1. 下载 ff.zip
      - name: Download ff.zip
        run: |
          curl -L -o ff.zip "https://raw.githubusercontent.com/IY-CPU/test/main/%E6%9C%AC%E5%9C%B0%E5%BA%93%E3%80%90ff%E3%80%91.zip"

      # 2. 解压 ff.zip
      - name: Unzip ff.zip
        run: |
          rm -rf "本地库【ff】"
          unzip -o ff.zip

      # 3. 运行 extract.js（智能搜索 + 修复路径）
      - name: Extract JSON from api.json
        run: |
          node extract.js

      # 4. 调试输出
      - name: Debug TXT content
        run: |
          echo "----- FILE LIST -----"
          ls -R "本地库【ff】"
          echo "----- TXT CONTENT START -----"
          cat 天神IY.txt || echo "TXT NOT FOUND"
          echo "----- TXT CONTENT END -----"

      # 5. 合并补丁
      - name: Run merge script
        run: |
          node merge.js

      # 6. 提交结果
      - name: Commit and push changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "本地库【ff】" 天神IY.txt iy_merged.json
          git commit -m "Auto-sync ff.zip & rebuild merged interface" || echo "No changes to commit"
          git push

